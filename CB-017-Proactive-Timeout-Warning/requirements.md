# CB-017: Proactive Timeout Warning

## Overview

Implement a proactive timeout warning feature that automatically sends a message to users before their conversation times out, informing them about the upcoming timeout and that subsequent messages will start a new conversation.

## Problem Statement

Currently, users are only informed about conversation timeout when they send a new message after the session has already expired. This can lead to confusion and loss of conversation context without warning.

## Requirements

### Functional Requirements

1. **Proactive Warning Message**
   - Send an automated warning message X minutes before conversation timeout (configurable, default: 5 minutes)
   - Warning should inform users that the conversation will timeout soon
   - Message should mention that messages after timeout will start a new conversation

2. **Warning Message Generation**
   - Use the LangFlow OTHER flow to generate the timeout warning message
   - Include context about timeout timing in the prompt
   - Fall back to static message if LangFlow is unavailable

3. **Timer Management**
   - Track last activity time for each active conversation
   - Schedule timeout warning based on conversation timeout setting minus warning buffer
   - Reset/reschedule warning timer on each user interaction
   - Clear scheduled warnings when conversation ends or is restarted

4. **Channel Support**
   - Support MS Teams channel (primary)
   - Maintain conversation reference (serviceUrl, conversationId) for proactive messaging

### Non-Functional Requirements

1. **Performance**
   - Efficient in-memory timer management
   - Minimal memory footprint per conversation
   - Automatic cleanup of stale timers

2. **Configurability**
   - Enable/disable feature via environment variable
   - Configurable warning time before timeout
   - Configurable conversation timeout (existing)

3. **Reliability**
   - Handle service restarts gracefully (timers reset)
   - Handle proactive message failures silently (log but don't crash)
   - Don't send warning if user already active

## Configuration

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `ENABLE_TIMEOUT_WARNING` | `false` | Enable/disable timeout warning feature |
| `TIMEOUT_WARNING_MINUTES` | `5` | Minutes before timeout to send warning |
| `CONVERSATION_TIMEOUT_MINUTES` | `30` | Existing - total conversation timeout |

### Example Configuration

```bash
# Enable timeout warning feature
ENABLE_TIMEOUT_WARNING=true

# Send warning 5 minutes before 30-minute timeout
TIMEOUT_WARNING_MINUTES=5
CONVERSATION_TIMEOUT_MINUTES=30
# Warning will be sent at 25 minutes of inactivity
```

## User Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                    USER SENDS MESSAGE                           │
│                           ↓                                     │
│              Reset timeout warning timer                        │
│              Schedule warning at (timeout - warning) minutes    │
│                           ↓                                     │
│              ... user inactive for X minutes ...                │
│                           ↓                                     │
│              ┌─────────────────────────────────┐                │
│              │  TIMEOUT WARNING TRIGGERED      │                │
│              │  (X = timeout - warning time)   │                │
│              │                                  │                │
│              │  1. Generate warning via OTHER  │                │
│              │  2. Send proactive message      │                │
│              │  3. Log warning sent            │                │
│              └─────────────────────────────────┘                │
│                           ↓                                     │
│              ... additional Y minutes pass ...                  │
│                           ↓                                     │
│              Conversation times out                             │
│              Next message starts new conversation               │
└─────────────────────────────────────────────────────────────────┘
```

## Acceptance Criteria

1. ✅ Timeout warning is sent proactively before conversation expires
2. ✅ Warning time is configurable via environment variable
3. ✅ Feature can be enabled/disabled via environment variable
4. ✅ Warning message is generated by LangFlow OTHER flow
5. ✅ Timer resets when user sends a new message
6. ✅ No warning sent if conversation is actively being used
7. ✅ Stale timers are cleaned up automatically
8. ✅ MS Teams proactive messaging works correctly

## Dependencies

- `MSTeamsService` - For sending proactive messages
- `UserService` - For getting user conversation info
- `OtherFlow` (LangFlow) - For generating warning messages
- `config/index.js` - For configuration
- `ConversationLifecycleService` - For timeout settings

## Related Documentation

- [CB-006-Conversation-Lifecycle](../CB-006-Conversation-Lifecycle/) - Original lifecycle implementation
- [flows/MISCELLANEOUS/README.md](../../flows/MISCELLANEOUS/README.md) - OTHER flow documentation
