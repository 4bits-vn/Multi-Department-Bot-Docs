# CB-001: Implementation - Consolidated Bot Framework Workflow

## Summary

Successfully implemented the consolidated workflow for the Bot Framework server with the following features:

1. **User Validation Flow**: Azure Table ‚Üí ServiceNow ‚Üí Exception Flow
2. **Session Management**: UUID v7 for session IDs
3. **Intent Classification**: LangFlow ROUTER flow
4. **Webhook Routing**: Process routing results and call sub-flows (session-based lookup)
5. **Typing Indicators**: User feedback at each processing step
6. **Exception Handling**: JSON-based exception responses with RESTART_CONVERSATION action

## Files Created

| File | Description |
|------|-------------|
| `src/utils/uuid.js` | UUID v7 generation utility for session IDs |
| `src/Services/ConversationStateService.js` | State machine for conversation lifecycle |

## Files Modified

| File | Changes |
|------|---------|
| `package.json` | Added `uuid` v13.0.0 dependency |
| `src/Services/UserService.js` | Added session fields and methods |
| `src/Handlers/LangFlowHandler.js` | Added ROUTER, EXCEPTION, KB Search, Ticketing flows |
| `src/server.js` | Implemented consolidated workflow and routing webhook |
| `src/utils/index.js` | Exported UUID utilities |
| `README.md` | Updated documentation with new workflow |

## Key Implementation Details

### 1. Session ID vs MS Teams Conversation ID

**IMPORTANT**: These are two different identifiers serving different purposes:

| Aspect | Session ID (`chat_session_id`) | MS Teams Conversation ID (`conversationId`) |
|--------|-------------------------------|---------------------------------------------|
| **What is it** | UUID v7 generated by botframework | Native Teams conversation identifier |
| **Purpose** | Manage chat session with LangFlow | Route messages to Teams conversation |
| **Generator** | `generateSessionId()` using `uuidv7()` | MS Teams platform |
| **Storage** | Users table (`chat_session_id` field) | Conversations table (`conversationId` field) |
| **Format** | UUID v7: `018f6e1e-7c9b-7xxx-xxxx-xxxxxxxxxxxx` | Teams format: `19:meeting_...` or `a:1m...` |
| **Used in** | LangFlow `session_id` parameter | `msTeamsService.sendProactiveMessage()` |

### 2. UUID v7 Session Management

```javascript
// src/utils/uuid.js
const { v7: uuidv7 } = require('uuid');

function generateSessionId() {
    return uuidv7();  // Time-ordered unique IDs
}
```

### 3. User Service Session Fields

New fields added to user records:
- `chat_session_id`: UUID v7 session ID (NOT the Teams conversation ID)
- `current_input`: Last user message
- `next_action`: Current processing state
- `next_action_updated_at`: State timestamp

New methods:
- `getOrCreateSession(email, channel)`: Get existing or create new session
- `updateUserState(email, channel, stateData)`: Update conversation state
- `clearSession(email, channel)`: Clear session for fresh start
- `findUserBySessionId(sessionId)`: Look up user by UUID v7 session ID (for webhook handlers)

### 4. LangFlowHandler Methods

| Method | Purpose |
|--------|---------|
| `sendToRouter()` | Send message to ROUTER flow for intent classification |
| `sendToExceptionFlow()` | Generate error messages for invalid users (parses JSON response) |
| `parseExceptionResponse()` | Parse JSON from EXCEPTION flow |
| `callKBSearchFlow()` | Call knowledge base search flow |
| `callTicketingFlow()` | Call ticketing flow for ticket operations |
| `processRoutingResult()` | Process routing result and call appropriate sub-flow |

### 4.1 Exception Flow Response Format

LangFlow EXCEPTION flow returns JSON:
```json
{
  "situation": "UNKNOWN",
  "message": "We are unable to process your request at the moment. Please try again later or reach out for support.",
  "action": "RESTART_CONVERSATION"
}
```

**Actions:**
- `RESTART_CONVERSATION`: Clear session ID and reset state, user starts fresh
- `RETRY`: User can retry the operation
- `ESCALATE`: Escalate to human support
- `NONE`: No follow-up action needed

When `action` is `RESTART_CONVERSATION`, the bot:
1. Sends the error message to the user
2. Clears the user's `chat_session_id`
3. Resets conversation state to `IDLE`
4. User can start a new conversation

### 5. Conversation State Service

States:
- `IDLE`: No active processing
- `WAITING_FOR_LANGFLOW`: Awaiting LangFlow response
- `IT_KNOWLEDGE_SEARCH`: Processing KB search
- `IT_CREATE_TICKET`: Processing ticket creation
- `IT_TICKET_MANAGEMENT`: Processing ticket check
- `RESPONSE`: Direct response
- `COMPLETED`: Processing finished
- `ERROR`: Error occurred

### 6. Webhook Endpoints

| Endpoint | Purpose |
|----------|---------|
| `POST /api/webhook/langflow` | General LangFlow callback |
| `POST /api/webhook/langflow/routing` | ROUTER flow routing callback |

### 7. Consolidated Workflow (server.js)

```
handleTeamsMessage():
1. Get user info from Teams
2. Send typing indicator
3. Check debounce
4. Validate user (Azure Table ‚Üí ServiceNow ‚Üí Exception Flow)
5. Save conversation info
6. Get or create session ID (UUID v7)
7. Send typing indicator
8. Update state: WAITING_FOR_LANGFLOW
9. Call LangFlow ROUTER
10. (Webhook handles response)
```

## Environment Variables

New environment variables:

```bash
# LangFlow Flows
ROUTER_FLOW=<router_flow_id>       # Required
EXCEPTION_FLOW=<exception_flow_id>  # Optional
IT_KNOWLEDGE_SEARCH_FLOW=<kb_flow_id>         # Optional
TICKETING_FLOW=<ticket_flow_id>     # Optional

# Webhook
WEBHOOK_BASE_URL=<bot_public_url>
CODE_ACCESS_API=<api_key>           # For webhook authentication
```

## Testing

### Local Testing

1. Start the server:
   ```bash
   cd botframework
   pnpm dev
   ```

2. Server runs in mock mode when services not configured:
   - LangFlow returns mock responses
   - Azure Table uses in-memory storage
   - ServiceNow returns mock valid users

### Manual Testing Checklist

- [ ] New user message ‚Üí User validation passes
- [ ] Invalid user ‚Üí Exception flow returns error message
- [ ] Valid user ‚Üí Session ID created
- [ ] Message sent ‚Üí ROUTER flow called
- [ ] Routing webhook ‚Üí Response sent to user
- [ ] Typing indicators visible at each step
- [ ] Session persists across messages

## API Changes

### LangFlow Webhook Payload Format

LangFlow sends webhooks in this format:
```json
{
  "message": "Got it! Analyzing your request... üîç",
  "metadata": {
    "sender_name": "",
    "session_id": "6c9d3749-9d01-42fd-89b0-8c87ce7179bc"
  }
}
```

The bot looks up the user by `session_id` from `metadata.session_id`.

### Webhook Endpoints

**POST /api/webhook/langflow**

General LangFlow callback. Looks up user by session_id and sends the message.

**POST /api/webhook/langflow/routing**

ROUTER flow callback with optional routing result:
```json
{
  "message": "Response text",
  "metadata": {
    "session_id": "uuid-session-id",
    "routing_result": "IT_KNOWLEDGE_SEARCH",
    "sender_name": ""
  }
}
```

Response:
```json
{
  "message": "OK",
  "routingResult": "IT_KNOWLEDGE_SEARCH",
  "sent": true
}
```

### Session Lookup

Added `findUserBySessionId(sessionId)` to UserService:
- Searches Azure Table for user with matching `chat_session_id`
- Returns user + conversation data
- Used by webhooks to route responses to the correct user

## Known Limitations

1. **Single Instance**: Debounce uses in-memory storage (not shared across instances)
2. **Session Expiry**: Sessions don't auto-expire (manual cleanup needed)
3. **Retry Limits**: Max 2 retries for LangFlow calls

## Future Improvements

1. Add Redis for distributed debounce
2. Implement session expiry/cleanup
3. Add more detailed error tracking
4. Implement pending message processing
5. Add metrics/monitoring for flow performance

## Dependencies

```json
{
  "uuid": "^13.0.0"  // For UUID v7 generation
}
```

## Rollback Instructions

If issues arise:

1. Revert `server.js` to use `langFlowHandler.sendMessage()` instead of `sendToRouter()`
2. Remove routing webhook endpoint
3. Session fields in Azure Table can remain unused
4. UUID utility and ConversationStateService can remain (unused)

## References

- [LangFlow API Documentation](https://docs.langflow.org/api-reference-api-examples)
- [UUID v7 Specification](https://www.ietf.org/archive/id/draft-peabody-dispatch-new-uuid-format-04.html)
- [Azure Table Storage SDK](https://learn.microsoft.com/en-us/azure/cosmos-db/table/how-to-use-nodejs)
- [Bot Framework REST API](https://learn.microsoft.com/en-us/azure/bot-service/rest-api/bot-framework-rest-connector-api-reference)
